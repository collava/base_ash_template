defmodule AshBaseTemplate.Validations.Username do
  @moduledoc false
  use Ash.Resource.Validation

  @impl true
  def init(opts) do
    if is_binary(opts[:attribute]) do
      {:ok, opts}
    else
      {:error, "attribute must be a string!"}
    end
  end

  @impl true
  def validate(changeset, opts, _context) do
    value = Ash.Changeset.get_attribute(changeset, opts[:attribute])

    cond do
      is_nil(value) ->
        {:error, field: opts[:attribute], message: "must be present"}

      String.length(value) < 3 ->
        {:error, field: opts[:attribute], message: "must be at least 3 characters long"}

      reserved_username?(value) ->
        {:error, field: opts[:attribute], message: "is not allowed"}

      String.contains?(value, ".") ->
        {:error, field: opts[:attribute], message: "must not contain a dot"}

      true ->
        :ok
    end
  end

  # data from https://github.com/creativefoundrysg/disallowed-usernames
  defp reserved_username?(value) do
    # no extesion necessary
    my_domain = "mydomain"

    value in [
      "#{my_domain}",
      "#{my_domain}admin",
      "#{my_domain}administrator",
      "json",
      "rss",
      "well-known",
      "xml",
      "about",
      "abuse",
      "access",
      "account",
      "accounts",
      "activate",
      "ad",
      "add",
      "address",
      "adm",
      "admin",
      "administration",
      "administrator",
      "ads",
      "adult",
      "advertising",
      "affiliate",
      "affiliates",
      "ajax",
      "analytics",
      "android",
      "anon",
      "anonymous",
      "api",
      "app",
      "apps",
      "archive",
      "atom",
      "auth",
      "authentication",
      "autoconfig",
      "avatar",
      "backup",
      "bad",
      "banner",
      "banners",
      "best",
      "beta",
      "billing",
      "bin",
      "blackberry",
      "blog",
      "blogs",
      "board",
      "bot",
      "bots",
      "broadcasthost",
      "business",
      "cache",
      "calendar",
      "campaign",
      "career",
      "careers",
      "cart",
      "cdn",
      "cgi",
      "chat",
      "chef",
      "client",
      "clients",
      "code",
      "codes",
      "commercial",
      "community",
      "compare",
      "config",
      "connect",
      "contact",
      "contact-us",
      "contest",
      "cookie",
      "copyright",
      "corporate",
      "create",
      "crossdomain",
      "crossdomain.xml",
      "css",
      "customer",
      "dash",
      "dashboard",
      "data",
      "database",
      "db",
      "delete",
      "demo",
      "design",
      "designer",
      "dev",
      "devel",
      "developer",
      "developers",
      "development",
      "dir",
      "directory",
      "dmca",
      "doc",
      "docs",
      "documentation",
      "domain",
      "domainadmin",
      "domainadministrator",
      "download",
      "downloads",
      "dropbox",
      "drupal",
      "edit",
      "editor",
      "election",
      "email",
      "employee",
      "employees",
      "empty",
      "enquiry",
      "error",
      "event",
      "events",
      "exit",
      "export",
      "extra",
      "faq",
      "favorite",
      "feed",
      "feeds",
      "file",
      "files",
      "find",
      "finance",
      "firewall",
      "flash",
      "forum",
      "forums",
      "friend",
      "friends",
      "gadget",
      "gallery",
      "game",
      "games",
      "gift",
      "gifts",
      "go",
      "google",
      "group",
      "groups",
      "guest",
      "guests",
      "help",
      "home",
      "hosting",
      "image",
      "images",
      "import",
      "index",
      "info",
      "information",
      "inquiry",
      "invite",
      "isearch",
      "job",
      "jobs",
      "joomla",
      "js",
      "kb",
      "kitchen",
      "languages",
      "legal",
      "library",
      "life",
      "link",
      "links",
      "list",
      "lists",
      "location",
      "login",
      "logout",
      "lost",
      "mail",
      "manager",
      "marketing",
      "master",
      "member",
      "members",
      "message",
      "messages",
      "money",
      "monitoring",
      "more",
      "myaccount",
      "mydomain",
      "mysql",
      "name",
      "nameserver",
      "network",
      "news",
      "newspaper",
      "ngrok",
      "nodejs",
      "ns1",
      "ns2",
      "office",
      "offices",
      "online",
      "opencart",
      "opensource",
      "organization",
      "order",
      "orders",
      "page",
      "pages",
      "password",
      "paypal",
      "payment",
      "photos",
      "php",
      "picture",
      "pictures",
      "plan",
      "plans",
      "play",
      "player",
      "plugins",
      "pm",
      "pop3",
      "post",
      "posts",
      "pricing",
      "privacy",
      "private",
      "profile",
      "projects",
      "promo",
      "public",
      "python",
      "random",
      "recipe",
      "recipes",
      "register",
      "registration",
      "remove",
      "report",
      "reports",
      "request",
      "reset",
      "review",
      "reviews",
      "root",
      "roundcube",
      "router",
      "rss",
      "sale",
      "sales",
      "sample",
      "samples",
      "save",
      "script",
      "scripts",
      "search",
      "secure",
      "security",
      "send",
      "service",
      "services",
      "session",
      "setting",
      "settings",
      "shop",
      "shopping",
      "signin",
      "signout",
      "site",
      "sitemap",
      "sitemap.xml",
      "sites",
      "smtp",
      "sql",
      "src",
      "ssh",
      "ssl",
      "ssladmin",
      "ssladministrator",
      "sslwebmaster",
      "stage",
      "staging",
      "start",
      "stat",
      "static",
      "stats",
      "status",
      "store",
      "stores",
      "subdomain",
      "subscribe",
      "support",
      "surprise",
      "svn",
      "sys",
      "sysadmin",
      "sysop",
      "system",
      "tablet",
      "tablets",
      "task",
      "tasks",
      "tech",
      "telnet",
      "terms",
      "terms-of-use",
      "test",
      "test1",
      "test2",
      "test3",
      "tests",
      "theme",
      "themes",
      "tmp",
      "todo",
      "tools",
      "top",
      "trust",
      "tutorial",
      "tutorials",
      "tv",
      "twitter",
      "twittr",
      "unsubscribe",
      "update",
      "upload",
      "url",
      "usage",
      "usenet",
      "user",
      "users",
      "video",
      "videos",
      "visitor",
      "visitors",
      "webmail",
      "website",
      "websites",
      "welcome",
      "wiki",
      "wishlist",
      "wordpress",
      "work",
      "works",
      "write",
      "writer",
      "writers",
      "xmpp",
      "youtube"
    ]
  end
end
